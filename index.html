<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frequently Asked Questions</title>
  <style>
    body { 
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      margin: 20px;
    }
    #search-box {
      width: 70%;
      max-width: 600px;
      padding: 15px;
      margin: 20px auto;
      display: block;
      border-radius: 25px;
      border: 1px solid #0056b3;
      box-shadow: 0 4px 12px rgba(0, 85, 179, 0.2);
      transition: box-shadow 0.2s;
    }

    #search-box:focus {
      box-shadow: 0 8px 16px rgba(0, 85, 179, 0.4);
      border-color: #ffd700;
      outline: none;
    }

    #search-box::-webkit-search-cancel-button {
      -webkit-appearance: searchfield-cancel-button;
    }

    /* Topic Filter Dropdown Styling */
    #topic-filter {
      width: 25%;
      max-width: 250px;
      padding: 10px;
      margin: 0 10px;
      display: inline-block;
      border-radius: 15px;
      border: 1px solid #0056b3;
      background-color: #f0f8ff;
      color: #333;
      box-shadow: 0 4px 8px rgba(0, 85, 179, 0.2);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    #topic-filter:hover {
      background-color: #e6f0ff;
    }

    #topic-filter:focus {
      box-shadow: 0 8px 16px rgba(0, 85, 179, 0.4);
      outline: none;
    }

    /* Card Styling */
    .faq-card {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      background-color: #ffffff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
      cursor: pointer;
      position: relative;
    }
    
    .faq-card:hover {
      background-color: #f0f8ff;
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 85, 179, 0.2);
    }

    .faq-problem {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .faq-solution {
      font-size: 16px;
      color: #555;
      line-height: 1.5;
      display: none;
      margin-top: 15px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }

    .expand-btn {
      color: #007bff;
      cursor: pointer;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
      position: absolute;
      right: 20px;
      top: 20px;
    }

    /* Feedback Section Styling */
    #feedback-section {
      display: none;
      margin-top: 20px;
      text-align: center;
    }

    #feedback-section p {
      display: inline;
      margin-right: 10px;
    }

    .feedback-btn {
      padding: 10px;
      background-color: orange;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Featured FAQs Styling */
    #featured-faqs {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #fffcf0;
      border: 3px solid #ffcc00;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(255, 215, 0, 0.2);
    }

    #featured-title {
      font-size: 26px;
      font-weight: bold;
      color: #ff8c00;
      margin-bottom: 20px;
      text-align: center;
    }

    #featured-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    /* Centered Button Group */
    .button-group {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    /* View All FAQs Button */
    .view-all-btn {
      display: inline-block;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, background-color 0.2s;
    }

    .view-all-btn:hover {
      background-color: #004999;
      transform: scale(1.05);
    }

    /* Reset Search Button */
    .reset-btn {
      display: inline-block;
      padding: 10px 15px;
      background: linear-gradient(45deg, #ff5f6d, #ff0000);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, background-color 0.2s;
    }

    .reset-btn:hover {
      background: linear-gradient(45deg, #d70000, #ff3333);
      transform: scale(1.05);
    }

    /* Two Column Layout for FAQ Groups */
    .faq-list-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

  /* One Column layout for FAQ filtered by topic*/
  .faq-list-single-column {
    display: block;
    margin: 0 auto;
  }
  

  </style>
  <!-- Include Google Fonts and Fuse.js for fuzzy searching -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.5.3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
  <h1 style="text-align: center;">Frequently Asked Questions</h1>

  <input type="search" id="search-box" placeholder="Search FAQs by keyword or tag">
  <div class="button-group">
    <select id="topic-filter">
      <option value="">Filter by Topic</option>
    </select>
    <a href="javascript:void(0)" id="view-all-btn" class="view-all-btn" onclick="viewAllFAQs()">
      <i class="fas fa-list"></i> View All FAQs
    </a>
    <a href="javascript:void(0)" id="reset-btn" class="reset-btn" onclick="resetSearch()" style="display: none;">
      <i class="fas fa-times-circle"></i> Reset Search
    </a>
  </div>

  <div id="featured-faqs">
    <div id="featured-title">Featured FAQs</div>
    <div id="featured-list"></div>
  </div>

  <div id="faq-list" class="faq-list-container"></div>

  <div id="feedback-section">
    <p>Didn't find what you were looking for?</p>
    <a href="https://forms.gle/yVFaN8RYq2uzLkCMA" target="_blank">
      <button class="feedback-btn">Submit FAQ Request</button>
    </a>
  </div>

  <script type="text/javascript">
    let allFAQs = []; // Global variable to store all FAQs
    let fuse;  // Variable to store Fuse.js instance
    let lastSearchQuery = ''; // Track the last search query

    function loadGoogleSheetsAPI() {
      var script = document.createElement('script');
      script.src = 'https://www.gstatic.com/charts/loader.js';
      script.onload = initGoogleSheets;
      document.head.appendChild(script);
    }

    function initGoogleSheets() {
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(fetchFAQData);
    }

    function fetchFAQData() {
      const spreadsheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJiScHEwX_pwIaFkd-2-zhWMDiPCDMC5mpzEYimmGmUCPUp8vozJrgsOOX6VghkmxUr25ujSAkDJdo/pub?gid=568968512&single=true&output=csv';

      // Fetch the CSV and parse it with PapaParse
      fetch(spreadsheetURL)
        .then(response => response.text())
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,  // Use the first row as the header
            skipEmptyLines: true,  // Skip empty lines
            complete: function(results) {
              // Store the parsed data in the allFAQs array
              allFAQs = results.data.filter(row => row.Approved === 'TRUE').map(row => ({
                category: row.Category || '',
                topic: row.Topic || '',
                tags: row.Tags || '',
                problem: row.Problem_Question || '',
                solutionHtml: row.solutionHtml || '',  // Use the solution HTML column directly
                featured: row.Featured === 'TRUE'  // Check if the FAQ is featured
              }));

              populateTopicFilter(); // Populate the topic dropdown
              displayFeaturedFAQs();

              // Setup Fuse.js for searching
              setupFuse();  // Initialize Fuse.js with the FAQ data
            },
            error: function(error) {
              console.error('Error parsing CSV:', error);
            }
          });
        })
        .catch(error => console.error('Error fetching the sheet:', error));
    }

    function populateTopicFilter() {
      const topicFilter = document.getElementById('topic-filter');
      const uniqueTopics = [...new Set(allFAQs.map(faq => faq.topic).filter(topic => topic))];
      uniqueTopics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic;
        option.textContent = topic;
        topicFilter.appendChild(option);
      });

      topicFilter.addEventListener('change', function() {
        filterByTopic(this.value);
      });
    }

    function filterByTopic(topic) {
      if (topic) {
        const filteredFAQs = allFAQs.filter(faq => faq.topic === topic);
        const faqList = document.getElementById('faq-list');
        faqList.className = 'faq-list-single-column';  // Apply single-column class for filtering
        displayFAQs(filteredFAQs);
        document.getElementById('featured-faqs').style.display = 'none';
        document.getElementById('view-all-btn').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'inline-block';
      } else {
        resetSearch();
      }
    }

    function createCard(faq) {
      // Ensure problem and solution fields exist before processing
      if (!faq.problem || !faq.solutionHtml) {
        return '';  // Skip rendering this card if either field is missing
      }

      return `
        <div class="faq-card" onclick="toggleSolution(this)">
          <div class="faq-problem">${faq.problem}</div>
          <div class="faq-solution">${faq.solutionHtml}</div>
        </div>
      `;
    }

    // Toggle the expansion of the solution when the button is clicked or card is clicked
    function toggleSolution(card) {
      const solutionDiv = card.querySelector('.faq-solution');
      const expandBtn = card.querySelector('.expand-btn');

      if (solutionDiv.style.display === 'none' || solutionDiv.style.display === '') {
        // Expand the solution
        solutionDiv.style.display = 'block';
        if (expandBtn) expandBtn.textContent = 'Hide Solution';
      } else {
        // Collapse the solution
        solutionDiv.style.display = 'none';
        if (expandBtn) expandBtn.textContent = 'View Solution';
      }
    }

    function displayFAQs(faqs) {
      const faqList = document.getElementById('faq-list');
      faqList.innerHTML = faqs.map(createCard).join('');
      document.getElementById('feedback-section').style.display = 'block';
      document.getElementById('reset-btn').style.display = 'inline-block';
    }

    function displayFeaturedFAQs() {
      const featuredFAQs = allFAQs.filter(faq => faq.featured);
      const featuredList = document.getElementById('featured-list');
      if (featuredFAQs.length > 0) {
        featuredList.innerHTML = featuredFAQs.map(createCard).join('');
      } else {
        document.getElementById('featured-faqs').style.display = 'none';
      }
    }

    function setupFuse() {
      const fuseOptions = {
        keys: ['problem', 'solutionHtml', 'topic', 'tags'],
        threshold: 0.5,
        includeScore: true
      };

      fuse = new Fuse(allFAQs, fuseOptions);
        
      //setup debounce to reduce search frequency
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Set up the search functionality
      document.getElementById('search-box').addEventListener('input', debounce((e) => {
        const query = e.target.value.toLowerCase();
        lastSearchQuery = query; // Update last search query

        // Show feedback section when typing starts
        if (query) {
          const results = fuse.search(query).map(result => result.item);
          displayFAQs(results);
          document.getElementById('featured-faqs').style.display = 'none'; // Hide featured FAQs when searching
          document.getElementById('view-all-btn').style.display = 'none';
          document.getElementById('reset-btn').style.display = 'inline-block';
        } else {
          resetSearch();
        }
      }, 300));
    }

    function viewAllFAQs() {
      const groupedFAQs = allFAQs.reduce((group, faq) => {
        if (!group[faq.topic]) group[faq.topic] = [];
        group[faq.topic].push(faq);
        return group;
      }, {});

      const faqList = document.getElementById('faq-list');
      faqList.className = 'faq-list-container';  // Apply two-column class
      faqList.innerHTML = Object.entries(groupedFAQs).map(([topic, faqs]) => {
        return `
          <div class="faq-group">
            <h2>${topic}</h2>
            ${faqs.slice(0, 5).map(createCard).join('')}
            <button class="view-all-by-topic" onclick="viewAllByTopic('${topic}')" style="${faqs.length > 5 ? 'display: inline-block;' : 'display: none;'}">View All for ${topic}</button>
          </div>
        `;
      }).join('');
      
      document.getElementById('view-all-btn').style.display = 'none';
      document.getElementById('featured-faqs').style.display = 'none';
      document.getElementById('reset-btn').style.display = 'inline-block';
      document.getElementById('feedback-section').style.display = 'block';
    }

    function viewAllByTopic(topic) {
      const filteredFAQs = allFAQs.filter(faq => faq.topic === topic);
      const topicContainer = [...document.querySelectorAll('.faq-group')].find(group => group.querySelector('h2').innerText === topic);
      topicContainer.innerHTML = `
        <h2>${topic}</h2>
        ${filteredFAQs.map(createCard).join('')}
      `;
    }

    function resetSearch() {
      document.getElementById('faq-list').innerHTML = '';
      document.getElementById('feedback-section').style.display = 'none';
      document.getElementById('featured-faqs').style.display = 'block';
      document.getElementById('view-all-btn').style.display = 'inline-block';
      document.getElementById('reset-btn').style.display = 'none';
      document.getElementById('topic-filter').value = '';
      document.getElementById('search-box').value = '';
    }

    loadGoogleSheetsAPI();
  </script>
</body>
</html>
